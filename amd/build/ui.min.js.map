{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Plugin tiny_cloze for TinyMCE v6 in Moodle.\n *\n * @module      tiny_cloze/ui\n * @copyright   2023 MoodleDACH\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalEvents from 'core/modal_events';\nimport Modal from 'core/modal';\nimport ModalFactory from 'core/modal_factory';\nimport Mustache from 'core/mustache';\nimport {get_strings as getStrings} from 'core/str';\nimport {component} from './common';\nimport {hasQtypeMultianswerrgx, getLanguages} from './options';\nimport {\n  CSS, TEMPLATE,\n  markerClass, markerSpan,\n  isNull, strdecode, strencode, indexOfNode,\n  getUuid, getFractionOptions, getQuestionTypes,\n  hasInvalidChars, isCustomGrade, setStr,\n  selectCustomPercent\n} from './cloze';\n\n// Language strings used in the modal dialogue.\nconst STR = {};\n\n/**\n * The editor instance that is injected via the onInit() function.\n *\n * @type {tinymce.Editor}\n * @private\n */\nlet _editor = null;\n\n/**\n * A reference to the currently open form.\n *\n * @param _form\n * @type {Node}\n * @private\n */\nlet _form = null;\n\n/**\n * An array containing the current answers options\n *\n * @param _answerdata\n * @type {Array}\n * @private\n */\nlet _answerdata = [];\n\n/**\n * The sub question type to be edited\n *\n * @param _qtype\n * @type {string|null}\n * @private\n */\nlet _qtype = null;\n\n/**\n * Remember the pos of the selected node.\n * @type {number}\n * @private\n */\nlet _selectedOffset = -1;\n\n/**\n * The maximum marks for the sub question\n *\n * @param _marks\n * @type {Integer}\n * @private\n */\nlet _marks = 1;\n\n/**\n * The modal dialogue to be displayed when designing the cloze question types.\n * @type {Modal|null}\n */\nlet _modal = null;\n\n/**\n * If its a normal selection of text, use it for the first answer field.\n * @type {string|null}\n */\nlet _firstAnswer = null;\n\n/**\n * When selecting a text portion that is used for the first answer field, remember\n * any whitespace before and after the selection.\n * 0 => no whitespace, 1 => whitespace before, 2 => whitespace after, 3 => whitespace before and after.\n * @type {int}\n */\nlet _selectedPrefixAndSuffix = 0;\n\n/**\n * Inject the editor instance and add markers to the cloze question texts.\n * @param {tinymce.Editor} ed\n */\nconst onInit = function(ed) {\n  _editor = ed; // The current editor instance.\n  // Add the marker spans.\n  _addMarkers();\n  // And get the language strings.\n  _getStr();\n};\n\n/**\n * Regex to recognize the question string in the text e.g. {1:NUMERICAL:...} or {:MULTICHOICE:...}\n * @param {tinymce.Editor} editor\n * @return {RegExp}\n * @private\n */\nconst _getRegexQtype = (editor) => {\n  // eslint-disable-next-line max-len\n  const baseQtypes = 'MULTICHOICE(_H|_V|_S|_HS|_VS)?|MULTIRESPONSE(_H|_S|_HS)?|NUMERICAL|SHORTANSWER(_C)?|SAC?|NM|MWC?|M[CR](V|H|VS|HS)?';\n  const extQtypes = hasQtypeMultianswerrgx(editor) ? '|REGEXP(_C)?|RXC?' : '';\n  return new RegExp('\\\\{([0-9]*):(' + baseQtypes + extQtypes + '):(.*?)(?<!\\\\\\\\)\\\\}', 'g');\n};\n\n/**\n * Load strings for the modal dialogue from the language packs.\n * @private\n */\nconst _getStr = async() => {\n  let strToFetch = [\n    {key: 'answer', component: 'question'},\n    {key: 'chooseqtypetoadd', component: 'question'},\n    {key: 'defaultmark', component: 'question'},\n    {key: 'feedback', component: 'question'},\n    {key: 'correct', component: 'question'},\n    {key: 'incorrect', component: 'question'},\n    {key: 'addmoreanswerblanks', component: 'qtype_calculated'},\n    {key: 'delete', component: 'core'},\n    {key: 'up', component: 'core'},\n    {key: 'down', component: 'core'},\n    {key: 'tolerance', component: 'qtype_calculated'},\n    {key: 'gradenoun', component: 'core'},\n    {key: 'caseno', component: 'mod_quiz'},\n    {key: 'caseyes', component: 'mod_quiz'},\n    {key: 'answersingleno', component: 'qtype_multichoice'},\n    {key: 'answersingleyes', component: 'qtype_multichoice'},\n    {key: 'layoutselectinline', component: 'qtype_multianswer'},\n    {key: 'layouthorizontal', component: 'qtype_multianswer'},\n    {key: 'layoutvertical', component: 'qtype_multianswer'},\n    {key: 'shufflewithin', component: 'mod_quiz'},\n    {key: 'layoutmultiple_horizontal', component: 'qtype_multianswer'},\n    {key: 'layoutmultiple_vertical', component: 'qtype_multianswer'},\n    {key: 'pluginnamesummary', component: 'qtype_multichoice'},\n    {key: 'pluginnamesummary', component: 'qtype_shortanswer'},\n    {key: 'pluginnamesummary', component: 'qtype_numerical'},\n    {key: 'multichoice', component},\n    {key: 'multiresponse', component},\n    {key: 'numerical', component: 'mod_quiz'},\n    {key: 'shortanswer', component: 'mod_quiz'},\n    {key: 'cancel', component: 'core'},\n    {key: 'select', component},\n    {key: 'insert', component},\n    {key: 'pluginname', component},\n    {key: 'customgrade', component},\n    {key: 'err_custom_rate', component},\n    {key: 'err_empty_answer', component},\n    {key: 'err_none_correct', component},\n    {key: 'err_not_numeric', component},\n    {key: 'err_invalid_chars', component},\n  ];\n  let langKeys = [\n    'answer',\n    'chooseqtypetoadd',\n    'defaultmark',\n    'feedback',\n    'correct',\n    'incorrect',\n    'addmoreanswerblanks',\n    'delete',\n    'up',\n    'down',\n    'tolerance',\n    'grade',\n    'caseno',\n    'caseyes',\n    'singleno',\n    'singleyes',\n    'selectinline',\n    'horizontal',\n    'vertical',\n    'shuffle',\n    'multi_horizontal',\n    'multi_vertical',\n    'summary_multichoice',\n    'summary_shortanswer',\n    'summary_numerical',\n    'multichoice',\n    'multiresponse',\n    'numerical',\n    'shortanswer',\n    'btn_cancel',\n    'btn_select',\n    'btn_insert',\n    'title',\n    'custom_grade',\n    'err_custom_rate',\n    'err_empty_answer',\n    'err_none_correct',\n    'err_not_numeric',\n    'err_invalid_chars',\n  ];\n  if (hasQtypeMultianswerrgx(_editor)) {\n    strToFetch.push({key: 'regexp', component: 'qtype_regexp'});\n    strToFetch.push({key: 'pluginnamesummary', component: 'qtype_regexp'});\n    langKeys.push('regexp');\n    langKeys.push('summary_regexp');\n  }\n  getStrings(strToFetch).then(function() {\n    const args = Array.from(arguments);\n    langKeys.map((l, i) => {\n      setStr(l, args[0][i]);\n      STR[l] = args[0][i];\n      return ''; // Make the linter happy.\n    });\n    return ''; // Make the linter happy.\n  }).catch(() => {\n    return '';\n  });\n};\n\n/**\n * Create the modal.\n * @return {Promise<void>}\n * @private\n */\nconst _createModal = async function() {\n  // Create the modal dialogue. Depending on whether we have a selected node or not, the content is different.\n  const cfg = {\n    title: STR.title,\n    templateContext: {\n      elementid: _editor.id\n    },\n    removeOnClose: true,\n    large: true,\n  };\n  if (typeof Modal.create === 'function') {\n    _modal = await Modal.create(cfg);\n  } else {\n    _modal = await ModalFactory.create(cfg);\n  }\n};\n\n/**\n * Display modal dialogue to edit a cloze question. Either a form is displayed to edit subquestion or a list\n * of possible questions is show.\n *\n * @method displayDialogue\n * @public\n */\nconst displayDialogue = async function() {\n  await _createModal();\n\n  // Resolve whether cursor is in a subquestion.\n  const subquestion = resolveSubquestion();\n  if (subquestion) {\n    _firstAnswer = null;\n    // Subquestion found, remember which node of the marker nodes is selected.\n    _selectedOffset = indexOfNode(_editor.dom.select('.' + markerClass), subquestion);\n    _parseSubquestion(subquestion.innerHTML);\n    _setDialogueContent(_qtype);\n  } else {\n    // No subquestion found, no offset to remember.\n    _selectedOffset = -1;\n    _firstAnswer = _editor.selection.getContent();\n    _selectedPrefixAndSuffix = 0;\n    if (_firstAnswer[0] === ' ') {\n      _selectedPrefixAndSuffix = 1;\n    }\n    if (_firstAnswer[_firstAnswer.length - 1] === ' ') {\n      _selectedPrefixAndSuffix += 2;\n    }\n    _firstAnswer = _firstAnswer.trim();\n    _setDialogueContent();\n  }\n};\n\n/**\n * On double click, check that we are on a question and display the dialogue with the question to edit.\n * @method displayDialogueForEdit\n * @param {Node} target\n * @public\n */\nconst displayDialogueForEdit = async function(target) {\n\n  const subquestion = resolveSubquestion(target);\n  if (!subquestion) {\n    return;\n  }\n  await _createModal();\n  _selectedOffset = indexOfNode(_editor.dom.select('.' + markerClass), subquestion);\n  _parseSubquestion(subquestion.innerHTML);\n  _setDialogueContent(_qtype);\n};\n\n/**\n * Search for cloze questions based on a regular expression. All the matching snippets at least contain the cloze\n * question definition. Although Moodle does not support encapsulated other functions within curly brackets, we\n * still try to find the correct closing bracket. The so extracted cloze question is surrounded by a marker span\n * element, that contains attributes so that the content inside the span cannot be modified by the editor (in the\n * textarea). Also, this makes it a lot easier to select the question, edit it in the dialogue and replace the result\n * in the existing text area.\n *\n * @method _addMarkers\n * @private\n */\nconst _addMarkers = function() {\n\n  let content = _editor.getContent();\n  let newContent = '';\n\n  // Check if there is already a marker span. In this case we do not have to do anything.\n  if (content.indexOf(markerClass) !== -1) {\n    return;\n  }\n\n  let m;\n  do {\n    m = content.match((_getRegexQtype(_editor)));\n    if (!m) { // No match of a cloze question, then we are done.\n      newContent += content;\n      break;\n    }\n    // Copy the current match to the new string preceded with the <span>.\n    const pos = content.indexOf(m[0]);\n    newContent += content.substring(0, pos) + markerSpan + content.substring(pos, pos + m[0].length);\n    content = content.substring(pos + m[0].length);\n\n    // Count the { in the string, should be just one (the very first one at position 0).\n    let level = (m[0].match(/\\{/g) || []).length;\n    if (level === 1) {\n      // If that's the case, we close the span and the cloze question text is the innerHTML of that marker span.\n      newContent += '</span>';\n      continue; // Look for the next matching cloze question.\n    }\n    // If there are more { than } in the string, then we did not find the corresponding } that belongs to the cloze string.\n    while (level > 1) {\n      const a = content.indexOf('{');\n      const b = content.indexOf('}');\n      if (a > -1 && b > -1 && a < b) { // The { is before another } so remember to find as many } until we back at level 1.\n        level++;\n        newContent = content.substring(0, a);\n        content = content.substring(a + 1);\n      } else if (b > -1) { // We found a closing } to a previously {.\n        newContent = content.substring(0, b);\n        content = content.substring(b + 1);\n        level--;\n      } else {\n        level = 1; // Should not happen, just to stop the endless loop.\n      }\n    }\n    newContent += '</span>';\n  } while (m);\n  _editor.setContent(newContent);\n};\n\n/**\n * Look for the marker span elements around a cloze question and remove that span. Also, the marker for a new\n * node to be inserted would be removed here as well.\n */\nconst _removeMarkers = function() {\n  for (const span of _editor.dom.select('span.' + markerClass)) {\n    _editor.dom.setOuterHTML(span, span.classList.contains('new') ? '' : span.innerHTML);\n  }\n};\n\n/**\n * When the source code view dialogue is show, we must remove the spans around the cloze question strings\n * from the editor content and add them again when the dialogue is closed.\n * Since this event is also triggered when the editor data is saved, we use this function to remove the\n * highlighting content at that time.\n *\n * @method onBeforeGetContent\n * @param {object} content\n * @public\n */\nconst onBeforeGetContent = function(content) {\n  if (!isNull(content.source_view) && content.source_view === true) {\n    // If the user clicks on 'Cancel' or the close button on the html\n    // source code dialog view, make sure we re-add the visual styling.\n    var onClose = function() {\n      _editor.off('close', onClose);\n      _addMarkers();\n    };\n    _editor.on('CloseWindow', () => {\n      onClose();\n    });\n    // Remove markers only if modal is not called, otherwise we will lose our new question marker.\n    if (!_modal) {\n      _removeMarkers();\n    }\n  }\n};\n\n/**\n * Fires when the form containing the editor is submitted.\n *\n * @method onSubmit\n * @public\n */\nconst onSubmit = function() {\n  _removeMarkers();\n};\n\n/**\n * Set the dialogue content for the tool, attaching any required events. Either the modal dialogue displays\n * a list of the question types for the form for a particular question to edit. The set content is also\n * called when the form has changed (up or down move, deletion and adding a response). We must be aware of that\n * an event to the dialogue buttons must be attached once only. Therefore, when the form content is modified, only\n * the form events for the answers are set again, the general events are nor (nomodalevents is true then).\n *\n * @method _setDialogueContent\n * @param {String} qtype The question type to be used\n * @param {boolean} nomodalevents Optional do not attach events.\n * @private\n */\nconst _setDialogueContent = function(qtype, nomodalevents) {\n  const footer = Mustache.render(TEMPLATE.FOOTER, {\n    cancel: STR.btn_cancel,\n    submit: !qtype ? STR.btn_select : STR.btn_insert,\n  });\n  let contentText;\n  if (!qtype) {\n    contentText = Mustache.render(TEMPLATE.TYPE, {\n      CSS: CSS,\n      STR: STR,\n      qtype: _qtype,\n      types: getQuestionTypes(hasQtypeMultianswerrgx(_editor))\n    });\n  } else {\n    const qtypeObj = getQuestionTypes(hasQtypeMultianswerrgx(_editor)).filter(q => _qtype === q.type)[0];\n    const contentData = {\n      CSS: CSS,\n      STR: STR,\n      SRC: {\n        ADD: M.util.image_url('t/add', 'core'),\n        DEL: M.util.image_url('t/delete', 'core'),\n        UP: M.util.image_url('t/up', 'core'),\n        DOWN: M.util.image_url('t/down', 'core'),\n      },\n      answerdata: _answerdata,\n      elementid: getUuid(),\n      qtype: _qtype,\n      name: qtypeObj.name,\n      marks: _marks,\n      numerical: (_qtype === 'NUMERICAL' || _qtype === 'NM'),\n    };\n    if (qtypeObj?.multilang) {\n      contentData.languages = getLanguages(_editor);\n      contentData.answerdata = _splitMultilangAnswer(_answerdata);\n    }\n    contentText = Mustache.render(TEMPLATE.FORM, contentData);\n  }\n  _modal.setBody(contentText);\n  _modal.setFooter(footer);\n  _modal.show();\n  const $root = _modal.getRoot();\n  _form = $root.get(0).querySelector('form');\n  _toggleDeleteIcon();\n\n  if (!nomodalevents) {\n    _modal.registerEventListeners();\n    _modal.registerCloseOnSave();\n    _modal.registerCloseOnCancel();\n    $root.on(ModalEvents.cancel, _cancel);\n\n    if (!qtype) { // For the question list we need the choice handler only, and we are done.\n      $root.on(ModalEvents.save, _choiceHandler);\n      return;\n    } // Handler to add the question string to the editor content.\n    $root.on(ModalEvents.save, _setSubquestion);\n  }\n  // The form needs events for the icons to move up/down, add or delete a response.\n  const getTarget = e => {\n    let p = e.target;\n    while (!isNull(p) && p.nodeType === 1 && p.tagName !== 'A') {\n      p = p.parentNode;\n    }\n    if (isNull(p.classList)) {\n      return null;\n    }\n    return p;\n  };\n\n  _form.addEventListener('click', e => {\n    const p = getTarget(e);\n    if (isNull(p)) {\n      return;\n    }\n    if (p.classList.contains(CSS.DELETE)) {\n      e.preventDefault();\n      _deleteAnswer(p);\n      return;\n    }\n    if (p.classList.contains(CSS.ADD)) {\n      e.preventDefault();\n      _addAnswer(p);\n      return;\n    }\n    if (p.classList.contains(CSS.LOWER)) {\n      e.preventDefault();\n      _lowerAnswer(p);\n      return;\n    }\n    if (p.classList.contains(CSS.RAISE)) {\n      e.preventDefault();\n      _raiseAnswer(p);\n    }\n  });\n  _form.addEventListener('keyup', e => {\n    const p = getTarget(e);\n    if (isNull(p)) {\n      return;\n    }\n    if (p.classList.contains(CSS.ANSWER) || p.classList.contains(CSS.FEEDBACK)) {\n      e.preventDefault();\n      _addAnswer(p);\n    }\n  });\n  _form.querySelectorAll('.' + CSS.FRACTION).forEach((sel) => {\n    sel.addEventListener('change', e => {\n      const id = e.target.getAttribute('id');\n      if (e.target.value === selectCustomPercent) {\n        document.getElementById(id + '_custom').parentNode.classList.remove('hidden');\n      } else {\n        document.getElementById(id + '_custom').parentNode.classList.add('hidden');\n      }\n    });\n  });\n};\n\n/**\n * If there is one answer field, hide the delete icon. Otherwise show them\n * all to allow deletion of any answer.\n *\n * @private\n */\nconst _toggleDeleteIcon = function() {\n  const deleteIcons = _form.querySelectorAll('.' + CSS.DELETE);\n  if (deleteIcons.length === 1) {\n    deleteIcons[0].classList.add('hidden');\n    return;\n  }\n  for (let i = 0; i < deleteIcons.length; i++) {\n    deleteIcons[i].classList.remove('hidden');\n  }\n};\n\n/**\n * Handle question choice.\n *\n * @method _choiceHandler\n * @private\n * @param {Event} e Event from button click in chooser\n */\nconst _choiceHandler = function(e) {\n  e.preventDefault();\n  let qtype = _form.querySelector('input[name=qtype]:checked');\n  if (qtype) {\n    _qtype = qtype.value;\n  }\n  // For numerical and short answer questions (and when installed regexp) we offer one response field only.\n  // All other question types have three empty response fields.\n  const max = (_qtype.indexOf('SHORTANSWER') !== -1 || _qtype === 'NUMERICAL' || _qtype.indexOf('REGEXP') !== -1) ? 1 : 3;\n  const blankAnswer = {\n    id: getUuid(),\n    answer: '',\n    feedback: '',\n    fraction: 100,\n    fractionOptions: getFractionOptions(''),\n    tolerance: 0,\n    isCustomGrade: false,\n  };\n  _answerdata = [];\n  for (let x = 0; x < max; x++) {\n    _answerdata.push({...blankAnswer, id: getUuid()});\n  }\n  // The first response field gets the default grade correct.\n  _answerdata[0].fractionOptions = getFractionOptions('=');\n  // In case the user seleced some text, this is used as the first answer.\n  if (_firstAnswer) {\n    _answerdata[0].answer = _firstAnswer;\n  }\n  _modal.destroy();\n  // Our choice is stored in _qtype. We need to create the modal dialogue with the form now.\n  _createModal().then(() => {\n    _setDialogueContent(_qtype);\n    _form.querySelector('.' + CSS.ANSWER).focus();\n    return ''; // Make the linter happy.\n  }).catch(() => {\n      return '';\n  });\n};\n\nconst _getHtmlForLanguageOptions = function(languages, options, id, type) {\n  let html = '';\n  languages.forEach(lang => {\n    html += Mustache.render(TEMPLATE.INPUT_LANG, {\n      img: lang.iso === 'ALL' ? M.util.image_url('i/language', 'core') : '',\n      label: lang.iso.toUpperCase(),\n      title: lang.label,\n      csstype: type === 'answer' ? CSS.ANSWER : CSS.FEEDBACK,\n      name: `${id}_${type}_${lang.iso}`,\n      value: options[lang.iso] ?? '',\n    });\n  });\n  return html;\n};\n\nconst _splitMultilangAnswer = function(answerOptions) {\n  const languages = getLanguages(_editor);\n  languages.unshift({'iso': 'ALL', label: ''});\n  for (let i = 0; i < answerOptions.length; i++) {\n    answerOptions[i].answer_by_language_html = _getHtmlForLanguageOptions(\n      languages, _splitMultilangStr(answerOptions[i].answer), answerOptions[i].id, 'answer');\n    answerOptions[i].feedback_by_language_html = _getHtmlForLanguageOptions(\n      languages, _splitMultilangStr(answerOptions[i].feedback), answerOptions[i].id, 'feedback');\n  }\n  return answerOptions;\n};\n\nconst _splitMultilangStr = function(str) {\n  // Start with this shortcut before actually parsing the string,\n  if (str.length === 0 || str.indexOf('</span>') === -1) {\n    return {'all': str};\n  }\n  // Parse the string as html to find all occurences of <span class=\"multilang\"...\n  const dom = new DOMParser();\n  const rootNode = dom.parseFromString(str, 'text/html').body.firstElementChild;\n  const langStr = {};\n  rootNode.querySelectorAll('span.multilang').forEach(e => {\n    const iso = e.getAttribute('lang') ?? '';\n    if (iso.length > 0) {\n      langStr[iso.toUpperCase()] = e.innerHTML;\n    }\n  });\n  // The language parts are sepatated by iso code.\n  langStr['all'] = Object.keys(langStr).length > 0 ? '' : str;\n  return langStr;\n};\n\n/**\n * Parse question and set properties found.\n *\n * @method _parseSubquestion\n * @private\n * @param {String} question The question string\n */\nconst _parseSubquestion = function(question) {\n  _answerdata = []; // Flush answers to have an empty dialogue if something goes wrong parsing the question string.\n  const regexQtype = _getRegexQtype(_editor);\n  const parts = regexQtype.exec(question);\n  regexQtype.lastIndex = 0; // Reset lastIndex so that the next match starts from the beginning of the question string.\n  if (!parts) {\n    return;\n  }\n  _marks = parts[1];\n  _qtype = parts[2];\n  // Convert the short notation to the long form e.g. SA to SHORTANSWER.\n  if (_qtype.length < 5) {\n    getQuestionTypes(hasQtypeMultianswerrgx(_editor)).forEach(l => {\n      for (const a of l.abbr) {\n        if (a === _qtype) {\n          _qtype = l.type;\n          return;\n        }\n      }\n    });\n  }\n  // Depending on the regex the position of the answers is different.\n  const answers = parts[hasQtypeMultianswerrgx(_editor) ? 8 : 7].match(/(\\\\.|[^~])*/g);\n  if (!answers) {\n    return;\n  }\n  answers.forEach(function(answer) {\n    const options = /^(%(-?[.0-9]+)%|(=?))((\\\\.|[^#])*)#?(.*)/.exec(answer);\n    if (options && options[4]) {\n      let frac = '';\n      if (options[3]) {\n        frac = options[3] === '=' ? '=' : 100;\n      } else if (options[2]) {\n        frac = options[2];\n      }\n      if (_qtype === 'NUMERICAL' || _qtype === 'NM') {\n        const tolerance = /^([^:]*):?(.*)/.exec(options[4])[2] || 0;\n        _answerdata.push({\n          id: getUuid(),\n          answer: strdecode(options[4].replace(/:.*/, '')),\n          feedback: strdecode(options[6]),\n          tolerance: tolerance,\n          fraction: frac,\n          fractionOptions: getFractionOptions(frac),\n          isCustomGrade: isCustomGrade(frac),\n        });\n        return;\n      }\n      _answerdata.push({\n        answer: strdecode(options[4]),\n        id: getUuid(),\n        feedback: strdecode(options[6]),\n        fraction: frac,\n        fractionOptions: getFractionOptions(frac),\n        isCustomGrade: isCustomGrade(frac),\n      });\n    }\n  });\n};\n\n/**\n * Insert a new set of answer blanks below the button.\n *\n * @method _addAnswer\n * @param {Node} a Node that is the referred element\n * @private\n */\nconst _addAnswer = function(a) {\n  let index = indexOfNode(_form.querySelectorAll('.' + CSS.ADD), a);\n  if (index === -1) {\n    index = 0;\n  }\n  let fraction = '';\n  let answer = '';\n  let feedback = '';\n  let tolerance = 0;\n  if (a.closest('li')) {\n    fraction = a.closest('li').querySelector('.' + CSS.FRACTION).value;\n    if (fraction === selectCustomPercent) {\n      fraction = a.closest('li').querySelector('.' + CSS.FRAC_CUSTOM).value;\n    }\n    answer = a.closest('li').querySelector('.' + CSS.ANSWER).value;\n    feedback = a.closest('li').querySelector('.' + CSS.FEEDBACK).value;\n    if (a.closest('li').querySelector('.' + CSS.TOLERANCE)) {\n      tolerance = a.closest('li').querySelector('.' + CSS.TOLERANCE).value;\n    }\n  }\n  _processFormData();\n  _answerdata.splice(index, 0, {\n    id: getUuid(),\n    answer: answer,\n    feedback: feedback,\n    fraction: fraction,\n    fractionOptions: getFractionOptions(fraction),\n    tolerance: tolerance,\n    isCustomGrade: isCustomGrade(fraction)\n  });\n  _setDialogueContent(_qtype, true);\n  _toggleDeleteIcon();\n  _form.querySelectorAll('.' + CSS.ANSWER).item(index).focus();\n};\n\n/**\n * Delete set of answer next to the button.\n *\n * @method _deleteAnswer\n * @param {Node} a Node that is the referred element\n * @private\n */\nconst _deleteAnswer = function(a) {\n  let index = indexOfNode(_form.querySelectorAll('.' + CSS.DELETE), a);\n  if (index === -1) {\n    index = indexOfNode(_form.querySelectorAll('li'), a.closest('li'));\n  }\n  _processFormData();\n  _answerdata.splice(index, 1);\n  _setDialogueContent(_qtype, true);\n  const answers = _form.querySelectorAll('.' + CSS.ANSWER);\n  index = Math.min(index, answers.length - 1);\n  answers.item(index).focus();\n  _toggleDeleteIcon();\n};\n\n/**\n * Lower answer option\n *\n * @method _lowerAnswer\n * @param {Node} a Node that is the referred element\n * @private\n */\nconst _lowerAnswer = function(a) {\n  const li = a.closest('li');\n  li.before(li.nextSibling);\n  li.querySelector('.' + CSS.ANSWER).focus();\n};\n\n/**\n * Raise answer option\n *\n * @method _raiseAnswer\n * @param {Node} a Node that is the referred element\n * @private\n */\nconst _raiseAnswer = function(a) {\n  const li = a.closest('li');\n  li.after(li.previousSibling);\n  li.querySelector('.' + CSS.ANSWER).focus();\n};\n\n/**\n * Reset and hide form.\n *\n * @method _cancel\n * @param {Event} e Event from button click\n * @private\n */\nconst _cancel = function(e) {\n  e.preventDefault();\n  // In case there is a marker where the new question should be inserted in the text it needs to be removed.\n  for (const span of _editor.dom.select('.' + markerClass + '.new')) {\n    span.remove();\n  }\n  _modal.destroy();\n  _editor.focus();\n  _modal = null;\n};\n\n/**\n * Insert question string into editor content and reset and hide form. If the form contains an error\n * nothing happens.\n *\n * @method _setSubquestion\n * @param {Event} e Event from button click\n * @private\n */\nconst _setSubquestion = function(e) {\n  e.preventDefault();\n  // Check if there are any errors and if so, fill the error container with the\n  // messages and return without going any further and closing the dialogue.\n  const errMsg = _form.querySelector('.msg-error');\n  const formErrors = _processFormData(true);\n  if (formErrors.length > 0) {\n    errMsg.innerHTML = '<ul><li>' + formErrors.join('</li><li>') + '</li></ul>';\n    errMsg.classList.remove('hidden');\n    return;\n  } else {\n    errMsg.classList.add('hidden');\n  }\n  // Build the parser function from the data, that is going to be placed into the editor content.\n  let question = '{' + _marks + ':' + _qtype + ':';\n\n  // Filter all empty responses\n  for (let i = 0; i < _answerdata.length; i++) {\n    if (_answerdata[i].raw === '') {\n      continue;\n    }\n    question += _answerdata[i].fraction && !isNaN(_answerdata[i].fraction)\n      ? '%' + _answerdata[i].fraction + '%' : _answerdata[i].fraction;\n    question += strencode(_answerdata[i].answer);\n    if (_qtype === 'NM' || _qtype === 'NUMERICAL') {\n      question += ':' + _answerdata[i].tolerance;\n    }\n    if (_answerdata[i].feedback) {\n      question += '#' + strencode(_answerdata[i].feedback);\n    }\n    if (i < _answerdata.length - 1) {\n      question += '~';\n    }\n  }\n  if (question.slice(-1) === '~') {\n    question = question.substring(0, question.length - 1);\n  }\n  question += '}';\n  // eslint-disable-next-line no-bitwise\n  if (_selectedPrefixAndSuffix & 1) {\n    question = ' ' + question;\n  }\n  // eslint-disable-next-line no-bitwise\n  if (_selectedPrefixAndSuffix & 2) {\n    question += ' ';\n  }\n\n  _modal.destroy();\n  _modal = null;\n  _editor.focus();\n  if (_selectedOffset > -1) { // We have to replace one of the marker spans (the innerHTML contains the question string).\n    _editor.dom.select('.' + markerClass)[_selectedOffset].innerHTML = question;\n  } else {\n    // Just add the question text with markup.\n    _editor.insertContent(markerSpan + question + '</span>');\n  }\n};\n\n/**\n * Read the form data, process it and store the result in the internal _answerdata array.\n * Also, if validation is enabled, the fields are checked for invalid values e.g.\n * - answer field is empty (if a correct answer is contained, empty fields are eliminated).\n * - custom_grade field whenin use and does not contain a number.\n * - no field is marked as a correct answer.\n * - tolerance field must be in percentage of min -100 and max 100.\n * Any field with an error is maked and the first field containing an error gets the focus.\n *\n * @method _processFormData\n * @param {boolean} validate\n * @return {Array}\n * @private\n */\nconst _processFormData = function(validate) {\n  _answerdata = [];\n  let globalErrors = [];\n  const answers = _form.querySelectorAll('.' + CSS.ANSWER);\n  const feedbacks = _form.querySelectorAll('.' + CSS.FEEDBACK);\n  const fractions = _form.querySelectorAll('.' + CSS.FRACTION);\n  const customGrades = _form.querySelectorAll('.' + CSS.FRAC_CUSTOM);\n  const tolerances = _form.querySelectorAll('.' + CSS.TOLERANCE);\n  // Remove any error classes.\n  for (let i = 0; i < answers.length; i++) {\n    answers.item(i).classList.remove('error');\n    customGrades.item(i).classList.remove('error');\n    const currentAnswer = {\n      raw: answers.item(i).value.trim(),\n      answer: answers.item(i).value.trim(),\n      id: getUuid(),\n      feedback: feedbacks.item(i).value,\n      fraction: fractions.item(i).value === selectCustomPercent ? customGrades.item(i).value : fractions.item(i).value,\n      fractionOptions: getFractionOptions(fractions.item(i).value),\n      tolerance: tolerances.length > 0 ? tolerances.item(i).value : 0,\n      isCustomGrade: fractions.item(i).value === selectCustomPercent\n    };\n    if (_qtype === 'NM' || _qtype === 'NUMERICAL') {\n      tolerances.item(i).classList.remove('error');\n      // In numeric questions convert answer and tolerance to numeric values (this filters non numeric values).\n      currentAnswer.answer = Number(currentAnswer.answer);\n      currentAnswer.tolerance = Number(currentAnswer.tolerance);\n    }\n    _answerdata.push(currentAnswer);\n  }\n  _marks = _form.querySelector('.' + CSS.MARKS).value;\n\n  if (validate) {\n    const {hasCorrectAnswer, errors} = _validateAnswers();\n    for (let i = 0; i < _answerdata.length; i++) {\n      for (const err of _answerdata[i].hasErrors) {\n        // Automatically remove empty answer fields for convenience if there is at least one correct answer.\n        if (hasCorrectAnswer && (err === 'empty_answer' || err === 'correct_but_empty')) {\n          break;\n        }\n        if (err === 'answer_not_numeric' || err === 'empty_answer'\n          || err === 'correct_but_empty' || err === 'answer_invalid_chars'\n        ) {\n          answers.item(i).classList.add('error');\n        } else if (err === 'tolerance_not_numeric') {\n          tolerances.item(i).classList.add('error');\n        } else if (err === 'error_custom_rate') {\n          customGrades.item(i).classList.add('error');\n        }\n      }\n    }\n    globalErrors = _translateGlobalErrors(hasCorrectAnswer, errors);\n    // If we have errors, we focus the first field that contains an error.\n    if (globalErrors.length > 0) {\n      _form.querySelector('input.error').focus();\n    }\n  }\n  return globalErrors;\n};\n\n/**\n * Validates the answer array. Checks for each question if the data from the form is\n * incomplete or has other errors. These are flagged accordingly in the array element.\n * The retruned object contains the properties:\n * - hasCorrectAnswer {boolean} is true if there is at least one correct answer.\n * - errors {Array} list of strings that contain an error code that is globaly used for error messages.\n *\n * @return {Array}\n * @private\n */\nconst _validateAnswers = function() {\n  let errors = [];\n  let hasCorrect = false;\n  for (let i = 0; i < _answerdata.length; i++) {\n    _answerdata[i].hasErrors = [];\n    // Check if we have an empty answer string.\n    if (_answerdata[i].raw === '') {\n      _answerdata[i].hasErrors.push('empty_answer');\n    }\n    // When there are numeric questions, check that the answer and tolerance is a valid number.\n    if (_qtype === 'NM' || _qtype === 'NUMERICAL') {\n      if (isNaN(_answerdata[i].answer) && _answerdata[i].raw !== '') {\n        _answerdata[i].hasErrors.push('answer_not_numeric');\n      }\n      if (isNaN(_answerdata[i].tolerance)) {\n        _answerdata[i].hasErrors.push('tolerance_not_numeric');\n      }\n    }\n    // Regex answers can use the . ^ $ * + { } \\ / as a literal only (preceeded by a backslash).\n    if ((_qtype === 'REGEXP' || _qtype === 'REGEXP_C') && hasInvalidChars(_answerdata[i].raw)) {\n      _answerdata[i].hasErrors.push('answer_invalid_chars');\n    }\n    // Check the custom grade, that must be a percentage number between -100 and 100.\n    if (_answerdata[i].isCustomGrade &&\n      (isNaN(_answerdata[i].fraction) || _answerdata[i].fraction < -100 || _answerdata[i].fraction > 100\n        || _answerdata[i].fraction.trim() === '')\n    ) {\n      _answerdata[i].hasErrors.push('error_custom_rate');\n    }\n    // We found a correct answer, when grade is marked as 100 or \"=\" and the answer is not empty.\n    if (_answerdata[i].fraction === '100' || _answerdata[i].fraction === '=') {\n      if (_answerdata[i].raw !== '') {\n        _answerdata[i].isCorrect = true;\n        hasCorrect = true;\n      } else {\n        _answerdata[i].hasErrors.push('correct_but_empty');\n      }\n    }\n    errors = errors.concat(_answerdata[i].hasErrors);\n  }\n\n  return {\n    hasCorrectAnswer: hasCorrect,\n    errors: _combineGlobalErrors(hasCorrect, errors),\n  };\n};\n\n/**\n * Translate the errors into a readable string for a list that is used on top of the\n * input fields, to indicate what part of the data is incorrect.\n *\n * @param {Boolean} hasCorrectAnswer\n * @param {Array} errors\n * @return {Array}\n * @private\n */\nconst _translateGlobalErrors = function(hasCorrectAnswer, errors) {\n  const errTranslated = [];\n  // Translate the error strings into a string that can be displayed in the form.\n  const trMsg = {\n    emptyanswer: STR.err_empty_answer,\n    answernotnumeric: STR.err_not_numeric,\n    tolerancenotnumeric: STR.err_not_numeric,\n    errorcustomrate: STR.err_custom_rate,\n    nonecorrect: STR.err_none_correct,\n    answerinvalidchars: STR.err_invalid_chars,\n  };\n  for (const err of errors) {\n    // If there's at least one correct answer, we filter out all empty answers and therefore do not\n    // show the error message.\n    if (hasCorrectAnswer && err === 'empty_answer' || err === 'correct_but_empty') {\n      continue;\n    }\n    // Remove underscore (we do this only because of the js linter).\n    const key = err.replace(/_/g, '');\n    errTranslated.push(trMsg[key]);\n  }\n  return errTranslated;\n};\n\n/**\n * Combine the error list from the answers to a global list.\n *\n * @param {Boolean} hasCorrectAnswer\n * @param {Array} errors\n * @return {Array}\n * @private\n */\nconst _combineGlobalErrors = function(hasCorrectAnswer, errors) {\n  // Unique errors for the global error list.\n  const errUnique = errors.filter((value, index, array) => array.indexOf(value) === index);\n  // If we have a correct answer, do not show the empty answer error, because empty responses are filtered.\n  if (hasCorrectAnswer) {\n    const i = errUnique.indexOf('empty_answer');\n    if (i > -1) {\n      errUnique.splice(i, 1);\n    }\n  } else if (!errUnique.includes('correct_but_empty')) {\n    errUnique.push('none_correct');\n  }\n  return errUnique;\n};\n\n/**\n * Check whether cursor is in a subquestion and return subquestion text if\n * true.\n *\n * @method resolveSubquestion\n * @param {Node|null} element The element to check if it is a subquestion.\n * @return {Mixed} The selected node of with the subquestion if found, false otherwise.\n */\nconst resolveSubquestion = function(element) {\n  let span = element || _editor.selection.getStart();\n  if (!isNull(span.classList) && span.classList.contains(markerClass)) {\n    return span;\n  }\n  _editor.dom.getParents(span, elm => {\n    // Are we in a span that encapsulates the cloze question?\n    if (!isNull(elm.classList) && elm.classList.contains(markerClass)) {\n      return elm;\n    }\n    return false;\n  });\n  return false;\n};\n\nexport {\n  displayDialogue,\n  displayDialogueForEdit,\n  resolveSubquestion,\n  onInit,\n  onBeforeGetContent,\n  onSubmit,\n};\n"],"names":["STR","_editor","_form","_answerdata","_qtype","_selectedOffset","_marks","_modal","_firstAnswer","_selectedPrefixAndSuffix","ed","_addMarkers","_getStr","_getRegexQtype","editor","extQtypes","RegExp","async","strToFetch","key","component","langKeys","push","then","args","Array","from","arguments","map","l","i","catch","_createModal","cfg","title","templateContext","elementid","id","removeOnClose","large","Modal","create","ModalFactory","subquestion","resolveSubquestion","dom","select","markerClass","_parseSubquestion","innerHTML","_setDialogueContent","selection","getContent","length","trim","target","m","content","newContent","indexOf","match","pos","substring","markerSpan","level","a","b","setContent","_removeMarkers","span","setOuterHTML","classList","contains","source_view","onClose","off","on","qtype","nomodalevents","footer","Mustache","render","TEMPLATE","FOOTER","cancel","btn_cancel","submit","btn_insert","btn_select","contentText","qtypeObj","filter","q","type","contentData","CSS","SRC","ADD","M","util","image_url","DEL","UP","DOWN","answerdata","name","marks","numerical","multilang","languages","_splitMultilangAnswer","FORM","TYPE","types","setBody","setFooter","show","$root","getRoot","get","querySelector","_toggleDeleteIcon","registerEventListeners","registerCloseOnSave","registerCloseOnCancel","ModalEvents","_cancel","save","_choiceHandler","_setSubquestion","getTarget","e","p","nodeType","tagName","parentNode","addEventListener","DELETE","preventDefault","_deleteAnswer","_addAnswer","LOWER","_lowerAnswer","RAISE","_raiseAnswer","ANSWER","FEEDBACK","querySelectorAll","FRACTION","forEach","sel","getAttribute","value","selectCustomPercent","document","getElementById","remove","add","deleteIcons","max","blankAnswer","answer","feedback","fraction","fractionOptions","tolerance","isCustomGrade","x","destroy","focus","_getHtmlForLanguageOptions","options","html","lang","INPUT_LANG","img","iso","label","toUpperCase","csstype","answerOptions","unshift","answer_by_language_html","_splitMultilangStr","feedback_by_language_html","str","rootNode","DOMParser","parseFromString","body","firstElementChild","langStr","Object","keys","question","regexQtype","parts","exec","lastIndex","abbr","answers","frac","replace","index","closest","FRAC_CUSTOM","TOLERANCE","_processFormData","splice","item","Math","min","li","before","nextSibling","after","previousSibling","errMsg","formErrors","join","raw","isNaN","slice","insertContent","validate","globalErrors","feedbacks","fractions","customGrades","tolerances","currentAnswer","Number","MARKS","hasCorrectAnswer","errors","_validateAnswers","err","hasErrors","_translateGlobalErrors","hasCorrect","isCorrect","concat","_combineGlobalErrors","errTranslated","trMsg","emptyanswer","err_empty_answer","answernotnumeric","err_not_numeric","tolerancenotnumeric","errorcustomrate","err_custom_rate","nonecorrect","err_none_correct","answerinvalidchars","err_invalid_chars","errUnique","array","includes","element","getStart","getParents","elm"],"mappings":"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"}